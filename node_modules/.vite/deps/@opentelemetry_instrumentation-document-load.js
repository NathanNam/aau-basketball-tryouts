import {
  PerformanceTimingNames,
  addSpanNetworkEvent,
  addSpanNetworkEvents,
  hasKey
} from "./chunk-SDFO7HFY.js";
import {
  InstrumentationBase,
  SemconvStability,
  safeExecuteInTheMiddle,
  semconvStabilityFromStr
} from "./chunk-EF4EXS77.js";
import {
  TRACE_PARENT_HEADER,
  otperformance
} from "./chunk-MUUYURUO.js";
import {
  ATTR_URL_FULL,
  ATTR_USER_AGENT_ORIGINAL
} from "./chunk-JOJVESY7.js";
import {
  ROOT_CONTEXT,
  context,
  propagation,
  trace
} from "./chunk-WWXHSA53.js";
import "./chunk-CXVDPRWL.js";
import "./chunk-G3PMV62Z.js";

// node_modules/.pnpm/@opentelemetry+instrumentation-document-load@0.54.0_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/instrumentation-document-load/build/esm/enums/AttributeNames.js
var AttributeNames;
(function(AttributeNames2) {
  AttributeNames2["DOCUMENT_LOAD"] = "documentLoad";
  AttributeNames2["DOCUMENT_FETCH"] = "documentFetch";
  AttributeNames2["RESOURCE_FETCH"] = "resourceFetch";
})(AttributeNames || (AttributeNames = {}));

// node_modules/.pnpm/@opentelemetry+instrumentation-document-load@0.54.0_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/instrumentation-document-load/build/esm/version.js
var PACKAGE_VERSION = "0.54.0";
var PACKAGE_NAME = "@opentelemetry/instrumentation-document-load";

// node_modules/.pnpm/@opentelemetry+instrumentation-document-load@0.54.0_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/instrumentation-document-load/build/esm/semconv.js
var ATTR_HTTP_URL = "http.url";
var ATTR_HTTP_USER_AGENT = "http.user_agent";

// node_modules/.pnpm/@opentelemetry+instrumentation-document-load@0.54.0_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/instrumentation-document-load/build/esm/enums/EventNames.js
var EventNames;
(function(EventNames2) {
  EventNames2["FIRST_PAINT"] = "firstPaint";
  EventNames2["FIRST_CONTENTFUL_PAINT"] = "firstContentfulPaint";
})(EventNames || (EventNames = {}));

// node_modules/.pnpm/@opentelemetry+instrumentation-document-load@0.54.0_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/instrumentation-document-load/build/esm/utils.js
var getPerformanceNavigationEntries = () => {
  const entries = {};
  const performanceNavigationTiming = otperformance.getEntriesByType?.("navigation")[0];
  if (performanceNavigationTiming) {
    const keys = Object.values(PerformanceTimingNames);
    keys.forEach((key) => {
      if (hasKey(performanceNavigationTiming, key)) {
        const value = performanceNavigationTiming[key];
        if (typeof value === "number") {
          entries[key] = value;
        }
      }
    });
  } else {
    const perf = otperformance;
    const performanceTiming = perf.timing;
    if (performanceTiming) {
      const keys = Object.values(PerformanceTimingNames);
      keys.forEach((key) => {
        if (hasKey(performanceTiming, key)) {
          const value = performanceTiming[key];
          if (typeof value === "number") {
            entries[key] = value;
          }
        }
      });
    }
  }
  return entries;
};
var performancePaintNames = {
  "first-paint": EventNames.FIRST_PAINT,
  "first-contentful-paint": EventNames.FIRST_CONTENTFUL_PAINT
};
var addSpanPerformancePaintEvents = (span) => {
  const performancePaintTiming = otperformance.getEntriesByType?.("paint");
  if (performancePaintTiming) {
    performancePaintTiming.forEach(({ name, startTime }) => {
      if (hasKey(performancePaintNames, name)) {
        span.addEvent(performancePaintNames[name], startTime);
      }
    });
  }
};

// node_modules/.pnpm/@opentelemetry+instrumentation-document-load@0.54.0_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/instrumentation-document-load/build/esm/instrumentation.js
var DocumentLoadInstrumentation = class extends InstrumentationBase {
  component = "document-load";
  version = "1";
  moduleName = this.component;
  _semconvStability;
  constructor(config = {}) {
    super(PACKAGE_NAME, PACKAGE_VERSION, config);
    this._semconvStability = semconvStabilityFromStr("http", config?.semconvStabilityOptIn);
  }
  init() {
  }
  /**
   * callback to be executed when page is loaded
   */
  _onDocumentLoaded() {
    window.setTimeout(() => {
      this._collectPerformance();
    });
  }
  /**
   * Adds spans for all resources
   * @param rootSpan
   */
  _addResourcesSpans(rootSpan) {
    const resources = otperformance.getEntriesByType?.("resource");
    if (resources) {
      resources.forEach((resource) => {
        this._initResourceSpan(resource, rootSpan);
      });
    }
  }
  /**
   * Collects information about performance and creates appropriate spans
   */
  _collectPerformance() {
    const metaElement = Array.from(document.getElementsByTagName("meta")).find((e) => e.getAttribute("name") === TRACE_PARENT_HEADER);
    const entries = getPerformanceNavigationEntries();
    const traceparent = metaElement && metaElement.content || "";
    context.with(propagation.extract(ROOT_CONTEXT, { traceparent }), () => {
      const rootSpan = this._startSpan(AttributeNames.DOCUMENT_LOAD, PerformanceTimingNames.FETCH_START, entries);
      if (!rootSpan) {
        return;
      }
      context.with(trace.setSpan(context.active(), rootSpan), () => {
        const fetchSpan = this._startSpan(AttributeNames.DOCUMENT_FETCH, PerformanceTimingNames.FETCH_START, entries);
        if (fetchSpan) {
          if (this._semconvStability & SemconvStability.OLD) {
            fetchSpan.setAttribute(ATTR_HTTP_URL, location.href);
          }
          if (this._semconvStability & SemconvStability.STABLE) {
            fetchSpan.setAttribute(ATTR_URL_FULL, location.href);
          }
          context.with(trace.setSpan(context.active(), fetchSpan), () => {
            const skipOldSemconvContentLengthAttrs = !(this._semconvStability & SemconvStability.OLD);
            addSpanNetworkEvents(fetchSpan, entries, this.getConfig().ignoreNetworkEvents, void 0, skipOldSemconvContentLengthAttrs);
            this._addCustomAttributesOnSpan(fetchSpan, this.getConfig().applyCustomAttributesOnSpan?.documentFetch);
            this._endSpan(fetchSpan, PerformanceTimingNames.RESPONSE_END, entries);
          });
        }
      });
      if (this._semconvStability & SemconvStability.OLD) {
        rootSpan.setAttribute(ATTR_HTTP_URL, location.href);
        rootSpan.setAttribute(ATTR_HTTP_USER_AGENT, navigator.userAgent);
      }
      if (this._semconvStability & SemconvStability.STABLE) {
        rootSpan.setAttribute(ATTR_URL_FULL, location.href);
        rootSpan.setAttribute(ATTR_USER_AGENT_ORIGINAL, navigator.userAgent);
      }
      this._addResourcesSpans(rootSpan);
      if (!this.getConfig().ignoreNetworkEvents) {
        addSpanNetworkEvent(rootSpan, PerformanceTimingNames.FETCH_START, entries);
        addSpanNetworkEvent(rootSpan, PerformanceTimingNames.UNLOAD_EVENT_START, entries);
        addSpanNetworkEvent(rootSpan, PerformanceTimingNames.UNLOAD_EVENT_END, entries);
        addSpanNetworkEvent(rootSpan, PerformanceTimingNames.DOM_INTERACTIVE, entries);
        addSpanNetworkEvent(rootSpan, PerformanceTimingNames.DOM_CONTENT_LOADED_EVENT_START, entries);
        addSpanNetworkEvent(rootSpan, PerformanceTimingNames.DOM_CONTENT_LOADED_EVENT_END, entries);
        addSpanNetworkEvent(rootSpan, PerformanceTimingNames.DOM_COMPLETE, entries);
        addSpanNetworkEvent(rootSpan, PerformanceTimingNames.LOAD_EVENT_START, entries);
        addSpanNetworkEvent(rootSpan, PerformanceTimingNames.LOAD_EVENT_END, entries);
      }
      if (!this.getConfig().ignorePerformancePaintEvents) {
        addSpanPerformancePaintEvents(rootSpan);
      }
      this._addCustomAttributesOnSpan(rootSpan, this.getConfig().applyCustomAttributesOnSpan?.documentLoad);
      this._endSpan(rootSpan, PerformanceTimingNames.LOAD_EVENT_END, entries);
    });
  }
  /**
   * Helper function for ending span
   * @param span
   * @param performanceName name of performance entry for time end
   * @param entries
   */
  _endSpan(span, performanceName, entries) {
    if (span) {
      if (hasKey(entries, performanceName)) {
        span.end(entries[performanceName]);
      } else {
        span.end();
      }
    }
  }
  /**
   * Creates and ends a span with network information about resource added as timed events
   * @param resource
   * @param parentSpan
   */
  _initResourceSpan(resource, parentSpan) {
    const span = this._startSpan(AttributeNames.RESOURCE_FETCH, PerformanceTimingNames.FETCH_START, resource, parentSpan);
    if (span) {
      if (this._semconvStability & SemconvStability.OLD) {
        span.setAttribute(ATTR_HTTP_URL, resource.name);
      }
      if (this._semconvStability & SemconvStability.STABLE) {
        span.setAttribute(ATTR_URL_FULL, resource.name);
      }
      const skipOldSemconvContentLengthAttrs = !(this._semconvStability & SemconvStability.OLD);
      addSpanNetworkEvents(span, resource, this.getConfig().ignoreNetworkEvents, void 0, skipOldSemconvContentLengthAttrs);
      this._addCustomAttributesOnResourceSpan(span, resource, this.getConfig().applyCustomAttributesOnSpan?.resourceFetch);
      this._endSpan(span, PerformanceTimingNames.RESPONSE_END, resource);
    }
  }
  /**
   * Helper function for starting a span
   * @param spanName name of span
   * @param performanceName name of performance entry for time start
   * @param entries
   * @param parentSpan
   */
  _startSpan(spanName, performanceName, entries, parentSpan) {
    if (hasKey(entries, performanceName) && typeof entries[performanceName] === "number") {
      const span = this.tracer.startSpan(spanName, {
        startTime: entries[performanceName]
      }, parentSpan ? trace.setSpan(context.active(), parentSpan) : void 0);
      return span;
    }
    return void 0;
  }
  /**
   * executes callback {_onDocumentLoaded} when the page is loaded
   */
  _waitForPageLoad() {
    if (window.document.readyState === "complete") {
      this._onDocumentLoaded();
    } else {
      this._onDocumentLoaded = this._onDocumentLoaded.bind(this);
      window.addEventListener("load", this._onDocumentLoaded);
    }
  }
  /**
   * adds custom attributes to root span if configured
   */
  _addCustomAttributesOnSpan(span, applyCustomAttributesOnSpan) {
    if (applyCustomAttributesOnSpan) {
      safeExecuteInTheMiddle(() => applyCustomAttributesOnSpan(span), (error) => {
        if (!error) {
          return;
        }
        this._diag.error("addCustomAttributesOnSpan", error);
      }, true);
    }
  }
  /**
   * adds custom attributes to span if configured
   */
  _addCustomAttributesOnResourceSpan(span, resource, applyCustomAttributesOnSpan) {
    if (applyCustomAttributesOnSpan) {
      safeExecuteInTheMiddle(() => applyCustomAttributesOnSpan(span, resource), (error) => {
        if (!error) {
          return;
        }
        this._diag.error("addCustomAttributesOnResourceSpan", error);
      }, true);
    }
  }
  /**
   * implements enable function
   */
  enable() {
    window.removeEventListener("load", this._onDocumentLoaded);
    this._waitForPageLoad();
  }
  /**
   * implements disable function
   */
  disable() {
    window.removeEventListener("load", this._onDocumentLoaded);
  }
};
export {
  AttributeNames,
  DocumentLoadInstrumentation
};
//# sourceMappingURL=@opentelemetry_instrumentation-document-load.js.map
